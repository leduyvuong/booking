<% grouped = time_slots.group_by(&:date) %>
<% if grouped.empty? %>
  <p class="text-sm text-slate-500">No available time slots.</p>
<% else %>
  <div class="space-y-4">
    <% grouped.each do |date, slots| %>
      <div class="border border-slate-200 rounded-lg">
        <div class="px-4 py-2 bg-slate-100 text-sm font-semibold text-slate-700"><%= date.strftime('%A, %B %e') %></div>
        <ul class="divide-y divide-slate-200">
          <% slots.each do |slot| %>
            <li class="px-4 py-3 text-sm text-slate-600" data-controller="booking">
              <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <span class="font-medium text-slate-700"><%= slot.start_time.strftime('%H:%M') %> - <%= slot.end_time.strftime('%H:%M') %></span>
                <span class="mt-2 md:mt-0">Available slots: <%= slot.available_slots %></span>
                <% if user_signed_in? && current_user.patient_role? %>
                  <button data-action="booking#toggle" class="mt-3 md:mt-0 inline-flex items-center px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Book</button>
                <% end %>
              </div>

              <% if user_signed_in? && current_user.patient_role? %>
                <div data-booking-target="form" class="hidden mt-3 bg-slate-50 border border-slate-200 rounded-lg p-4">
                  <%= form_with url: appointments_path, scope: :appointment, class: "space-y-3" do |form| %>
                    <%= form.hidden_field :time_slot_id, value: slot.id %>
                    <div>
                      <%= form.label :patient_name, class: "block text-xs font-semibold text-slate-700 uppercase tracking-wide" %>
                      <%= form.text_field :patient_name, value: current_user.email.split('@').first.titleize, class: "mt-1 block w-full rounded-md border-slate-300" %>
                    </div>
                    <div>
                      <%= form.label :patient_phone, class: "block text-xs font-semibold text-slate-700 uppercase tracking-wide" %>
                      <%= form.telephone_field :patient_phone, class: "mt-1 block w-full rounded-md border-slate-300", required: true %>
                    </div>
                    <div>
                      <%= form.label :patient_email, class: "block text-xs font-semibold text-slate-700 uppercase tracking-wide" %>
                      <%= form.email_field :patient_email, value: current_user.email, class: "mt-1 block w-full rounded-md border-slate-300", required: true %>
                    </div>
                    <div>
                      <%= form.label :notes, class: "block text-xs font-semibold text-slate-700 uppercase tracking-wide" %>
                      <%= form.text_area :notes, rows: 3, class: "mt-1 block w-full rounded-md border-slate-300" %>
                    </div>
                    <%= form.submit "Confirm Booking", class: "inline-flex items-center px-3 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 transition" %>
                  <% end %>
                </div>
              <% end %>
            </li>
          <% end %>
        </ul>
      </div>
    <% end %>
  </div>
<% end %>
